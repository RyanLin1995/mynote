# Linux 账号与群组
一般登录 Linux 的时候，输入的是字符串的账号，但是其实 Linux 主机并不会直接认识字符串组成的账号，它仅认识 ID 。由于计算机仅认识 0 与 1，所以主机对于数字比较有概念的；至于账号只是为了让人们容易记忆而已。而 ID 与账号的对应就在 `/etc/passwd` 文件中。

每个登入 Linux 的使用者至少都会取得两个 ID ，一个是使用者 ID (User ID ，简称UID)、一个是群组 ID (Group ID ，简称 GID)。文件通过 UID 与 GID 判别它的拥有者与群组，当需要显示文件属性的需求时，系统会依据 `/etc/passwd` 与 `/etc/group` 的内容， 找到 UID / GID 对应的账号与组名再显示出来。

## 使用者账号
Linux 系统上面的用户如果需要登入主机以取得 shell 的环境来工作时，要先利用 tty1~tty6 的终端机提供的 login 接口，输入账号与密码登入 (网络登录使用 ssh) 。那么你输入账号密码后，系统会进行一下操作:
1. 匹配 `/etc/passwd` 里面是否存在输入的账号。没有则跳出，有则将该账号对应的 UID 与 GID (在 `/etc/group` 中) 读出来，且读出该账号的家目录与 shell 设定；
2. 再来则是在 `/etc/shadow` 里面找出对应的账号与 UID，然后核对一下输入的密码与保存的密码是否一致；
3. 如果一切都 OK ，就进入 Shell 

### /etc/passwd 与 /etc/shadow
#### /etc/passwd 文件结构
`/etc/passwd`中的文件结构是每一行都代表一个账号，有几行就代表有几个账号在系统中。
文件以 : 号作为分隔，每一个 : 是一个字段。

![passwd.png](https://i.loli.net/2021/05/05/sdBtir6CHN41XAO.png)

##### 字段详细说明：
* **1.账号名称**：即账号，用来登入系统且需要对应 UID 
* **2.密码**：代表该账号设置了密码，密码保存在` /etc/shadow 中``
* **3.UID**：使用者标识符，通常 Linux 对于 UID 有以下限制

|id 范围|该 ID 使用者特性|
|-|-|
|0 (系统管理员)|当 UID 是 0 时，代表这个账号是系统管理员，如果要让其他的账号也具有 root 的权限时，将该账号的 UID 改为 0 即可(但不建议)。也就是说，一个系统上不是叫 root 的就是系统管理员，而是 UID 为 0 的才是|
|1~999(系统账号)|保留给系统使用的 ID，除了 0 之外，其他的 UID 权限与特性并没有差别。由于系统上面启动的网络服务或背景服务希望使用较小的权限去运作，不希望直接使用 root 的身份去执行这些服务，所以默认 1000 以下的数字让给系统作为保留账号。这些系统账号通常是不可登入的。根据系统账号的由来，通常这类账号又约略被区分为两种：1~200：由 distributions 自行建立的系统账号；201~999：若用户有系统账号需求时，可以使用的账号 UID。|
|1000~60000(可登入账号)|给一般使用者建立账号使用|
* **4.GID**：关联 `/etc/group` 。通常新建账号时，也会在 `/etc/group` 中新建一个与账号名一样的 Group，两者就是靠 GID 关联起来
* **5.用户信息栏**：这个字段基本上并没有什么重要用途，只是用来解释这个账号的意义
* **6.家目录**：用户的家目录，默认为 `/home/yourIDname`， root 的家目录在 /root 。如果某个账号的使用空间特别的大，可修改这个字段将用户登入家目录修改到别的地方。
* **7.Shell**：指定用户登入系统后取得 Shell 的类型。如果要禁止账号取得 shell 环境，就是 /sbin/nologin
---
#### /etc/shadow 文件结构
`/etc/shadow` 文件结构跟 `/etc/passwd` 文件结构类似。每一行对应一个账号

* 问：为什么要有 `/etc/shadow` 文件？
* 答：早期的密码放在 `/etc/passwd` 的第二个字段上，密码也有加密过。程序运行需要到
 `/etc/passwd` 读取账号的权限。因此 `/etc/passwd` 的权限需设定为 `-rw-r--r--`。
但是加密过的密码够透过暴力破解法破解出来。因为这样，后来发展出将密码移动到 /etc/shadow 这个文件分隔开来的技术， 而且只有 root 有权限访问 `/etc/shadow` 。

`/etc/shadow` 同样以 : 为分隔符，一个 : 是一个字段

![shadow.png](https://i.loli.net/2021/05/15/TtOZ4NyqVhReXwA.png)

##### 字段详细说明：
* **1. 账号名称：** 账号，必须要与 /etc/passwd 中的账号相同

* **2. 密码：** 账号真正的密码，经过编码(加密) 。密码的长度不能随意修改，因修改后长度不一致，可能导致密码就会失效(算不出来)。因此很多软件透过这个功能，在此字段前加上 ! 或 * 改变密码字段长度，让密码暂时失效

* **3. 最近更动密码的日期：** 记录了密码变更那一天的日期，数字 18658 为 Linux 系统从计算机开始时间(1970年1月1日)到密码变更的那一天的日期

* **4. 密码不可被更动的天数(与第 3 字段相比)：** 记录了这个账号最近一次被更改密码后需要经过几天才可以再变更密码。 0 表示密码随时可以变更的意思。设置了数字的话就指从改变密码那天起，多少天后才能再次变更密码。如设定为 20 天的话，则修改了密码之后 20 天后才能再次改密码

* **5. 密码需要重新变更的天数(与第 3 字段相比)：** 指定最近一次更改密码后，多少天数内需要再次变更密码，否则账号的密码将会变为过期特性。 99999 表示不需要变更密码

* **6. 密码需要变更期限前的警告天数(与第 5 字段相比)：** 当账号的密码有效期限快要到的时候(第 5 字段)，系统会依据这个字段的设定，发出警告信息，提醒用户修改密码

* **7. 密码过期后的账号宽限时间(密码失效日)(与第 5 字段相比)：** 在密码过期后，如果用户还是没有在宽限时间内登入更改密码，那么这个账号的密码将会失效，即该账号再也无法使用该密码登入了。要注意密码过期与密码失效并不相同。
密码有效日期为 更新日期(第 3 字段) + 重新变更日期(第 5 字段)，过了该期限后用户依旧没有更新密码，那该密码就过期。虽然密码过期但是该账号还是可以用来进行其他工作的，包括登入系统取得bash。但当用户登入系统时，系统会强制要求必须要重新设定密码才能登入

* **8. 账号失效日期：** 账号在此字段规定的日期(以 1970 年为基准)之后，将无法再使用。即账号失效，此时不论你的密码是否有过期，这个账号都不能再使用

* **9. 保留：** 保留字段，看以后有没有新功能加入。

**例子(来源于鸟哥的 Linux 私房菜)：**
![shadow1.png](https://i.loli.net/2021/05/15/vTCEOJNHxtno4Wa.png)
注：16559 为 2015/05/04
***以上代码的意义为：***
* 由于密码几乎仅能单向运算（由明码计算成为密码，无法由密码反推回明码），因此由上表的资料我们无法得知 dmstai 的实际密码明文（第二个字段）

* 此账号最近一次更动密码的日期是 2015/05/04（16559）

* 能够再次修改密码的时间是 5 天以后，也就是2015/05/09 以前 dmtsai 不能修改自己的密码。如果用户还是尝试更动自己的密码，系统就会出现这样的讯息：
`You must wait longer to change your password`
`passwd: Authentication token manipulation error`

* 由于密码过期日期定义为 60 天后，亦即为：16559+60=16619 (2015/07/03) 。 这表示：*用户必须要在 2015/05/09（前 5 天不能改）到 2015/07/03 之间的 60 天限制内去修改自己的密码，若 2015/07/03 之后还是没有变更密码时，该密码就过期*

* 警告日期设为 7 天，亦即是密码过期日前的 7 天，在本例中则代表 2015/06/26 ~ 2015/07/03 这七天。如果用户一直没有更改密码，那么在这 7 天中，只要 dmtsai 登录系统就会发现如下的警告：
`Warning: your password will expire in 5 days`

* 如果该账号一直到 2015/07/03 都没有更改密码，那么密码就会过期。但由于有 5 天的宽限天数，因此dmtsai 在 2015/07/08 前都还可以使用旧密码登入主机。不过登入时会出现强制更改密码的情况，画面有点像底下这样：
`You are required to change your password immediately (password aged)`
`WARNING: Your password has expired.`
`You must change your password now and login again!`
`Changing password for user dmtsai.`
`Changing password for dmtsai`
`(current) UNIX password:`
你必须要输入一次旧密码以及两次新密码后，才能够开始登入系统。如果你是在 2015/07/08 以后尝试以 dmtsai 登入的话，那么就会出现如下的错误讯息且无法登入，因为此时你的密码已经失效
`Your account has expired; please contact your system administrator`

* 如果用户在 2015/07/03 以前变更过密码，那么第 3 个字段的天数就会跟着改变，因此，所有的限制日期也会跟着相对变动

* 无论用户如何动作，到了 16679 (大约是 2015/09/01 左右）该帐号就失效

## 群组
群组分为有效群组(effective group)、初始群组(initial group)和支持群组(support groups)

* 支持群组(support groups)：每个使用者都可以拥有多个支持的群组，并拥有该群组的功能。

* 有效群组(effective group): 当前用户所使用的群组，一般为初始群组。影响文件的建立等

* 初始群组(initial group)：一般为账号创建时同时在`/etc/group`创建的群组。该群组与账号同名。一般作为账号登录时的群组
---
### 群组文件 /etc/group 与 /etc/gshadow
#### /etc/group 结构
![group.png](https://i.loli.net/2021/05/16/5S1G6MkQBDUlOFu.png)

`/etc/group` 以 : 进行分割，以下为字段详细说明：

* **1. 组名：** 群组名字，需要与第三字段的 GID 对应。一般也等同于 `/etc/passwd` 中的账号名
* **2. 群组密码：** 通常不需要设定，设定了是给群组管理员使用的，但因为存在 `sudo` 命令，目前很少有机会设定群组管理员。密码同样经移动到 /etc/gshadow 中，因此这个字段只会存在一个 x 
* **3. GID：** 群组 ID 。与 /etc/passwd 第四个字段使用的 GID 对应
* **4. 此群组支持的账号名称：** 一个账号可以加入多个群组，那某个账号想要加入此群组时，将该账号填入这个字段即可。 如果想要让 alex 与 jacky 也加入 ryan 这个群组，只需填写成这样 `ryan:x:0:alex,jacky` 

PS: 新版的 Linux 中，初始群组的用户群已经不会加入在自身的群组的第四个字段

#### /etc/gshadow 文件结构
![gshadow.png](https://i.loli.net/2021/05/16/ZvDanlWKk4Qi6mL.png)

`/etc/gshadow` 以 : 进行分割，以下为字段详细说明：

* **1. 组名：** 群组名字，与 `/etc/group` 对应
* **2. 密码栏：** 开头为 ! 或该字段为空，表示无合法密码，即无群组管理员
* **3. 群组管理员的账号：** 管理该群的管理员账号
* **4. 有加入该群组支持的所属账号：** 与 /etc/group 内容相同

PS：`/etc/gshadow` 最大的功能就是建立群组管理员，但因为有类似 `sudo` 之类的工具， 群组管理员的功能已经很少使用

---
### 有效群组的确定与切换
#### 有效群组的确定：groups
因为一个账号可以有多个支持群组。可以使用`groups`确定目前有效群组

用法：`groups`

![groups.png](https://i.loli.net/2021/05/16/zGpErNY1c4QakWP.png)

PS：一般第一个为当前有效群组，即当用户建立文档或目录时，改文档或目录属于当前有效群组

#### 有效群组的切换：newgrp
当用户需要切换自己的有效群组时，可以使用 `newgrp` 进行切换。但只能将账号支持群组切换为有效群组

用法：`newgrp [group name]`

![newgrp.png](https://i.loli.net/2021/05/16/wrI3JUi8lbudL4y.png)

PS：用户切换有效群组，实际上是另外以一个 shell 来提供这个功能。虽然用户的环境设定(例如环境变量等等其他数据)不会有影响，但是用户的群组权限将会重新被计算。因此如果你想要回到原本的环境中，需要用`exit`

用户切换有效群组图片说明(来自于鸟哥的Linux)：
![newgrp.gif](https://linux.vbird.org/linux_basic/centos7/0410accountmanager/newgrp.gif)

## /etc/passwd、/etc/group/与/etc/shadow 三者关系
![centos7_id_link](
https://linux.vbird.org/linux_basic/centos7/0410accountmanager/centos7_id_link.jpg)^图片来自于鸟哥的Linux^

图中 root 的 UID 是 0 ，而 GID 也是 0 ，通过 `/etc/group` 可知 GID 为 0 时的组名为 root 。至于密码，则会找到 `/etc/shadow` 与 `/etc/passwd`内同名的那一行

# 账号管理
## 新增账号
### 新增账号命令：useradd
用法：`useradd [-u UID] [-g 初始群组] [-G 支持群组] [-mM] [-c 说明栏] [-d 家目录绝对路径] [-s shell] 账号名称`

|选项与参数|说明|
|-|-|
|-u|后面接是 UID ，一组数字。直接指定一个特定的 UID 给这个账号|
|-g|后面接初始群组(initial group)，默认新建账号时会在 /etc/passwd 中新建同名的群组|
|-G|后面接支持群组(support groups)，即让新建的用户加入已存在的组|
|-M|强制不建立用户家目录(系统账号默认值)|
|-m|强制要建立用户家目录(一般账号默认值)，权限为700|
|-c|即 /etc/passwd 的第五栏的说明内容，可以随便设定|
|-d|指定某个目录成为家目录，而不要使用默认值。需绝对路径|
|-r|建立一个系统的账号，这个账号的 UID 会有限制 (参考 /etc/login.defs)|
|-s|后面用户可使用的 shell ，若没有指定则预设为 /bin/bash ；如果需要账号无法登录 shell ，可以使用 /bin/false|
|-e|后面接一个日期，格式为 YYYY-MM-DD ，写入 shadow 第八字段，即账号失效日|
|-f|后面接 shadow 的第七字段项目，指定密码是否会失效。0 为立刻失效，-1 为永远不失效(密码只会过期而强制于登入时重新设定而已)|

PS：`useradd -D` 可以建立账号时的默认参数，所有参数都在 `/etc/default/useradd` 中